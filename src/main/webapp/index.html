<!DOCTYPE html>
<html lang="en">
<head>
    <title>Three Of A Crime</title>
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
    <style type="text/css">
        body {
            margin-top: 20px;
        }
    </style>
    <script type="text/javascript">
        var innocentSuspects;
        $(document).ready(function () {
            $("#suspects").change(function () {
                checkFormElements();
            });

            $("#matches").change(function () {
                checkFormElements();
            });

            $("#clear").click(function () {
                $("#suspects :checked").each(function () {
                    $(this).removeAttr("checked");
                });
                checkFormElements();
            });

            $("#resetGame").on("click", function (e) {
                $("#confirm").modal({backdrop: "static", keyboard: false}).on("click", "#reset", function (e) {
                    startNewGame();
                });
            });

            $("#submit").click(function () {
                $.ajax({
                    type: "POST",
                    url: "/play",
                    data: {
                        "matchedSuspects": $("#suspects :checked").map(function () {
                            return $(this).val();
                        }).get(),
                        "matches": $("#matches :checked").val()
                    },
                    dataType: "json",
                    success: displaySuspects,
                });
            });
        });

        function displaySuspects(data, status, jqXHR) {
            clearResults();
            var suspectCards = data.suspectCards;
            $.each(suspectCards, function (index) {
                addSuspectCard(suspectCards[index]);
            });

            $("#clear").click();
            innocentSuspects = data.innocentSuspects;
            disableInnocentSuspects();
            if (suspectCards.length == 1) {
                $("#criminals").text(suspectCards[0]);
                $("#accusation").modal("show").on("click", "#newGame", function (e) {
                    startNewGame();
                });
            }
        }

        function checkFormElements() {
            if ($("#suspects :checked").length == 3) {
                $("#suspects :not(:checked)").each(function () {
                    $(this).attr("disabled", true);
                });
                if ($("#matches :checked").length > 0) {
                    $("#submit").removeAttr("disabled");
                }
            } else {
                $("#submit").attr("disabled", true);
                $("#suspects :not(:checked)").each(function () {
                    $(this).removeAttr("disabled");
                });
            }
            disableInnocentSuspects();
        }

        function addSuspectCard(suspects) {
            var suspectsTemplate = $("#suspectsTemplate").html();
            var result = suspectsTemplate.format(suspects);
            $("#results").append(result);
        }

        function disableInnocentSuspects() {
            if (innocentSuspects != null) {
                $.each(innocentSuspects, function (index) {
                    console.log(innocentSuspects[index]);
                    $("#suspects :checkbox[value='" + innocentSuspects[index] + "']").attr("disabled", true).parent().css("color", "#d3d3d3");
                });
            }
        }

        function clearResults() {
            $("#results").empty();
            $("#suspects :checkbox").removeAttr("hidden disabled").parent().css("color", "");
        }

        function startNewGame() {
            innocentSuspects = null;
            $.get("/play");
            $("#clear").click();
            clearResults();
        }

        String.prototype.format = function () {
            var args = arguments;
            return this.replace(/{(\d+)}/g, function (match, number) {
                return typeof args[number] != 'undefined' ? args[number] : match;
            });
        };
    </script>

    <script type="text/template" id="suspectsTemplate">
        <li class="list-group-item">{0}</li>
    </script>
</head>
<body>
<div class="container">
    <h1>Three Of A Crime</h1>
    <h4>Suspects</h4>

    <div id="suspects" class="btn-group">
        <label label-default="label-default" class="checkbox-inline">
            <input type="checkbox" value="HUMPTY_BUMPTY"/>HUMPTY BUMPTY</label>
        <label label-default="label-default" class="checkbox-inline">
            <input type="checkbox" value="JONNY_CORTEX"/>JONNY CORTEX</label>
        <label label-default="label-default" class="checkbox-inline">
            <input type="checkbox" value="KID_CASSIDY"/>KID CASSIDY</label>
        <label label-default="label-default" class="checkbox-inline">
            <input type="checkbox" value="LOOSE_EYE_LENNY"/>LOOSE-EYE LENNY</label>
        <label label-default="label-default" class="checkbox-inline">
            <input type="checkbox" value="LOUIE_ST_LOUIS"/>LOUIE ST. LOUIS</label>
        <label label-default="label-default" class="checkbox-inline">
            <input type="checkbox" value="NO_NECK_NICK"/>NO NECK NICK</label>
        <label label-default="label-default" class="checkbox-inline">
            <input type="checkbox" value="PENCIL_TOP"/>PENCIL TOP</label>
    </div>
    <br/>
    <h4>Matches</h4>

    <div id="matches" class="btn-group">
        <label label-default="label-default" class="radio-inline">
            <input type="radio" name="match" value="0"/>0</label>
        <label label-default="label-default" class="radio-inline">
            <input type="radio" name="match" value="1"/>1</label>
        <label label-default="label-default" class="radio-inline">
            <input type="radio" name="match" value="2"/>2</label>
    </div>
    <br/>
    <br/>
    <button id="submit" type="button" class="btn btn-primary" disabled>Submit</button>
    <button id="clear" type="button" class="btn btn-success">Clear</button>
    <button id="resetGame" type="button" class="btn btn-warning">Reset Game</button>
    <br/>
    <br/>

    <div class="row">
        <ul class="list-group">
            <div id="results"></div>
        </ul>
    </div>
    <div class="modal fade" id="confirm" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Start a new game?</h3>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    <button id="reset" type="button" class="btn btn-primary" data-dismiss="modal">Reset</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="accusation" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
         aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Accusation!</h3>
                </div>
                <div class="modal-body">
                    <div id="criminals" class="alert alert-success" role="alert"></div>
                </div>
                <div class="modal-footer">
                    <button id="newGame" type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>
